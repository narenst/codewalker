<html>
  <head>
    <style>
      body {
        color: black;
        width: 300px;
      }
    </style>
  </head>
  
  <body>
    <h2>Settings</h2>
    <form action="javascript:goToUrl();" id="goToUrl">
      <button type="submit" value="submit">Go To Google</button>
    </form>

    <input class="input-large" type="text" id="synctext" placeholder="Text to sync"/>
    <button type="submit" value="submit" id="sync">Sync</button>

    <br><br>

    <input type="radio" name="type" value="Master" id="type_master"/> Master 
    <input type="radio" name="type" value="Padawan" id="type_padawan" checked="checked"/> Padawan
    <br>

    <h4 id="status"></h4>
  </body>

  <script src='lib/jquery-1.7.1.min.js'></script>
  <script src='lib/bootstrap.min.js'></script>
  <script src="http://localhost:9000/socket.io/socket.io.js"></script>

  <script>
    var accessToken;

    function goToUrl() {
      console.log("going to www.google.com");
       chrome.tabs.executeScript(
         null, {code:"window.location.href='http://www.google.com'"}
       );
    }

    var socket = io.connect('http://localhost:9000');
    var masterSelected = false;
    var imMaster = false;

    // on connection to server
    socket.on('connect', function(){
      console.log("connected to nodejs server");
    });

    // update from server
    socket.on('update', function (username, data) {
      console.log("receiving data " + data);
      $('#synctext').val(data);
    });

    // master chosen
    socket.on('masterSelected', function (isMasterSelected) {
      console.log("incoming master selected message");
      $('#status').html('masterselected : ' + isMasterSelected);
      imMaster = $('#type_master').attr('checked');

      if (isMasterSelected && !imMaster) {
        //im the padawan
        $('#type_master').attr('disabled', true);
        $('#type_padawan').attr('disabled', true);
      } else {
        //no body is master
        $('#type_master').attr('disabled', false);
        $('#type_padawan').attr('disabled', false);
      }

      //start syncing
      if (isMasterSelected && imMaster) {
        $('#sync').attr('disabled', false);
      } else {
        $('#sync').attr('disabled', true);
      }
    });

    //send to server
    $('#sync').click(function() {
      console.log("sending data " + $('#synctext').val());
      socket.emit('sendupdate', $('#synctext').val());
    });

    $('#type_master').click(function() {
      console.log("selected master");
      socket.emit('selectMaster', "dummy");
    });

    $('#type_padawan').click(function() {
      console.log("cleared master");
      socket.emit('clearMaster', "dummy");
    });

    /*
    function getTokenFromSimperium() {
      authorizeUrl = "https://auth.simperium.com/1/fork-programs-2e6/authorize/";
      $.ajax(
        {
          type:"POST",
          url:authorizeUrl,
          data:"username=demo@locationlabs.com&password=demo",
          headers:{"X-Simperium-API-Key": "d06073458ad64f288e85a260338def7b"},
          success : function(result) {
            console.log("result : " + result);
            json = JSON.parse(result);
            $('#status').html("simperium token : " + json.access_token);
            return json.access_token;
          },
          error:function (xhr, ajaxOptions, thrownError){
            $('#status').html("failure : " + xhr.responseText);
            console.log(xhr.status);
            console.log(xhr.responseText);
          }
        }
      );
    }

    accessToken = getTokenFromSimperium();

    var simperium = new Simperium('fork-programs-2e6', { token : accessToken});
    var bucket = simperium.bucket('status');

    bucket.on('notify', function(id, data) {
        console.log("object " + id + " was updated!");
        $('#status').html("object " + id + " was updated!");
        console.log("new data is:");
        console.log(data);
        $('#synctext').val(data);
    });

    bucket.on('local', function(id) {
        console.log("request for local state for object " + id + " received");
        $('#status').html("request for local state for object " + id + " received");
        return $('#synctext').val();
    });

    bucket.start();
    */
  </script>
</html>